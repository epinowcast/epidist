---
title: "Using `epidist` to estimate stratified delays between symptom onset and positive test for the 2014-2016 Ebola outbreak in Sierra Leone"
description: "A more detailed guide to using the `epidist` R package"
output: 
  bookdown::html_document2:
    fig_caption: yes
    code_folding: show
    number_sections: true
pkgdown:
  as_is: true
# csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
link-citations: true
vignette: >
  %\VignetteIndexEntry{Getting in depth with epidist}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r setup, include=FALSE}
# exclude compile warnings from cmdstanr
knitr::opts_chunk$set(
  fig.path = "figures/epidist-",
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

The 2014-2016 outbreak of Ebola in West Africa began in Guinea, and quickly spread to neighbouring Liberia and Sierra Leone.
It was the largest outbreak in the disease's history, and resulted in over 28,600 infections and 11,325 deaths [@who_ebola_2014_2016].

In this vignette, we use the `epidist` package to analyze line list data from the outbreak in Sierra Leone.
This data was collated by @fang2016transmission.
We provide the data in the `epidist` package via `?sierra_leone_ebola_data`.

In analyzing this data, we demonstrate the following features of `epidist`:

1. Fitting district-sex stratified partially pooled delay distribution estimates.
2. Fitting models with lognormal and gamma delay distributions.
3. Post-processing and plotting functionality using the integration of `brms` functionality with the [`tidybayes`](http://mjskay.github.io/tidybayes/) package.
4. Selecting between fitted models using the [`loo`](https://mc-stan.org/loo/) package.

The packages used in this article are:

```{r load-requirements}
set.seed(1)

library(epidist)
library(data.table)
library(dplyr)
library(purrr)
library(ggplot2)
library(sf)
library(tidybayes)
library(modelr)
```

Note that, for users new to `epidist`, before reading this article we recommend beginning with the vignette "[Getting started with `epidist`](http://epidist.epinowcast.org/articles/epidist.html)".

# Data preparation

We begin by loading the Ebola line list data:

```{r}
data("sierra_leone_ebola_data")
```

The data has `r nrow(sierra_leone_ebola_data)` rows, each corresponding to a unique case report `id`.
The columns of the data are the individuals name (retracted, and hence can be removed), age, sex, the dates of Ebola symptom onset and positive sample, and their district and chiefdom.

```{r}
sierra_leone_ebola_data <- sierra_leone_ebola_data |>
  select(-name) |>
  mutate(case = as.integer(id), .keep = "unused")

head(sierra_leone_ebola_data)

fraction <- 5
ndistrict <- length(unique(sierra_leone_ebola_data$district))
```

Figure \@ref(fig:ebola-outbreak) shows the progression of the epidemic in each district.
(In this figure, we filter down to every `r fraction`th case in order to avoid overplotting.)
We can see that the start time and course of the epidemic varies between districts.

(ref:ebola-outbreak) Primary and secondary event times for every `r fraction`th case, over the `r ndistrict` districts of Sierra Leone.

```{r ebola-outbreak, fig.cap="(ref:ebola-outbreak)", fig.height=9}
sierra_leone_ebola_data |>
  filter(case %% fraction == 0) |>
  ggplot() +
  geom_segment(
    aes(
      x = date_of_symptom_onset, xend = date_of_sample_tested,
      y = case, yend = case
    ),
    col = "grey"
  ) +
  geom_point(aes(x = date_of_symptom_onset, y = case), col = "#56B4E9") +
  geom_point(aes(x = date_of_sample_tested, y = case), col = "#009E73") +
  facet_wrap(district ~ ., ncol = 2) +
  labs(x = "", y = "Case ID") +
  theme_minimal()
```

We can use a map to help visualise the outbreak across space.
To create a map, we first join the Ebola data to shapefiles for the districts of Sierra Leone.
These shapefiles were obtained from the Database of Global Administrative Areas ([GADM](https://gadm.org/)).

```{r message=FALSE, warning=FALSE}
sf <- sf::st_read(
  system.file("gadm41_SLE_shp/gadm41_SLE_2.shp", package = "epidist"),
  quiet = TRUE
)

sierra_leone_ebola_data_sf <- select(sf, district = NAME_2, geometry) |>
  left_join(
    sierra_leone_ebola_data |>
      group_by(district) |>
      summarise(cases = n())
  )
```

Figure \@ref(fig:ebola-cloropleth) shows that the majority of cases were concentrated in the Western Urban district.
This district contains the capital of the country, and has the highest population (as such, one may also be interested in the prevalence of Ebola, that is the number of cases divided by the population size).

(ref:ebola-cloropleth) A cloropleth showing the total number of Ebola cases in each district of Sierra Leone.

```{r ebola-cloropleth, fig.cap="(ref:ebola-cloropleth)"}
ggplot(sierra_leone_ebola_data_sf, aes(fill = cases, geometry = geometry)) +
  geom_sf() +
  scale_fill_viridis_c(na.value = "lightgrey") +
  theme_minimal() +
  labs(fill = "Cases")
```

# Fitting sex-district stratified delay distributions

To understand the delay between time of symptom onset and time of sample testing, we fit a range of statistical models using the `epidist` package.
In some of these models, we vary the parameters of the delay distribution by sex or by district.
For the lognormal delay distribution, which we begin by focusing on, these parameters are the mean and standard deviation of the underlying normal distribution.
That is, $\mu$ and $\sigma$ such that when $x \sim \mathcal{N}(\mu, \sigma)$ that $\exp(x)$ has a lognormal distribution.

## Data preparation

To prepare the data, we begin by transforming the date columns to `ptime` and `stime` columns for the times of the primary and secondary events respectively.
Both of these columns are relative to the first date of symptom onset in the data.
We also transform the `data.frame` to a `data.table`.

```{r}
sierra_leone_ebola_data <- sierra_leone_ebola_data |>
  mutate(
    date_of_symptom_onset = lubridate::ymd(date_of_symptom_onset),
    date_of_sample_tested = lubridate::ymd(date_of_sample_tested),
    ptime = as.numeric(date_of_symptom_onset - min(date_of_symptom_onset)),
    stime = as.numeric(date_of_sample_tested - min(date_of_symptom_onset))
  ) |>
  select(case, ptime, stime, age, sex, district) |>
  data.table::as.data.table()
```

The data now looks like:

```{r}
head(sierra_leone_ebola_data)
```

Next, we use `observe_process()` to add interval censoring columns giving the lower and upper bounds on the primary and secondary event times.

```{r}
obs_cens <- epidist::observe_process(sierra_leone_ebola_data)
```

Specially, the columns added by `observe_process` are:

* `ptime_daily`: As the `ptime` was already daily then this is superfluous
* `ptime_lwr`: The lower bound on the primary observation time i.e. the floor of `ptime_daily`
* `ptime_upr`: The upper bound on the primary observation time i.e. `ptime_lwr + 1`
* `stime_daily`: As the `ptime` was already daily then this is superfluous
* `stime_lwr`: The lower bound on the secondary observation time i.e. the floor of `stime_daily`
* `stime_upr`: The upper bound on the secondary observation time i.e. `stime_lwr + 1`
* `delay_daily`: Is given by `stime_daily - ptime_daily`
* `delay_lwr`: Is given by `stime_lwr - ptime_upr` i.e. the minimum possible delay
* `delay_upr`: Is given by `stime_upr - ptime_lwr` i.e. the maximum possible delay
* `obs_at`: The maximum value of `stime`

## Model fitting

Now we are ready to fit lognormal delay distributions to the data!
First, we start with a simple model that assumes the same delay distribution for all cases.

```{r}
subsample <- 0.2
```

For the time being, we filter the data to only complete cases (i.e. rows of the data which have no missing values^[It should be a relatively simple extension to allow for missing data in the model.]).
As well, to speed up computation, we take a random `r 100 * subsample`% subsample of the complete data.

```{r}
set.seed(1)
n <- nrow(obs_cens)
obs_cens <- obs_cens[complete.cases(obs_cens)]
n_complete <- nrow(obs_cens)
n_complete / n
obs_cens <- obs_cens[sample(seq_len(.N), n_complete * subsample, replace = FALSE)]
```

To prepare the data for use with the latent individual model, we use the function `as_latent_individual`:

```{r}
obs_prep <- as_latent_individual(obs_cens)
```

Now we are ready to fit the latent individual model.

### Intercept only model

We set `formula` to `brms::bf(mu ~ 1, sigma ~ 1)` to place an intercept only model on the `mu` and `sigma` parameters of the lognormal distribution.
This distribution is specified using `family = "lognormal"`.
We use the Laplace approximation via `algorithm = "laplace"` (see the approximate inference vignette) for fast model fitting.

```{r}
fit <- epidist(
  data = obs_prep,
  formula = brms::bf(mu ~ 1, sigma ~ 1),
  family = "lognormal",
  algorithm = "laplace",
  refresh = 0,
  silent = 2,
  seed = 1
)
```

The `fit` object is a [`brmsfit`](https://paulbuerkner.com/brms/reference/brmsfit-class.html) object, and has the associated range of methods.
See `methods(class = "brmsfit")` for more details.
For example, we may use `summary` to view information about the fitted model, including posterior estimates for the regression coefficients:

```{r}
summary(fit)
```

### Sex-stratified model

To fit a model which varies `mu` and `sigma` by sex we alter the `formula` specification to include fixed effects for sex as follows:

```{r}
fit_sex <- epidist(
  data = obs_prep,
  formula = brms::bf(mu ~ 1 + sex, sigma ~ 1 + sex),
  family = "lognormal",
  algorithm = "laplace",
  refresh = 0,
  silent = 2,
  seed = 1
)
```

A summary of the model shows that males tend to have longer delays (the posterior mean of `sexM` is `r round(summary(fit_sex)$fixed[3, "Estimate"], 2)`) and greater delay variation (the posterior mean of `sigma_sexM` is `r round(summary(fit_sex)$fixed[4, "Estimate"], 2)`):

```{r}
summary(fit_sex)
```

### Sex-district stratified model

Finally, we will fit a model which also varies by district.
To do this, we will use district level random effects, assumed to be drawn from a shared normal distribution, within the model for both the `mu` and `sigma` parameters:

```{r}
fit_sex_district <- epidist(
  data = obs_prep,
  formula = brms::bf(
    mu ~ 1 + sex + (1 | district),
    sigma ~ 1 + sex + (1 | district)
  ),
  family = "lognormal",
  algorithm = "laplace",
  refresh = 0,
  silent = 2,
  seed = 1
)
```

Along with looking at the `summary`, we may also use the `brms::ranef` function to look at the estimates of the random effects:

```{r}
summary(fit_sex_district)
brms::ranef(fit_sex_district)
```

## Posterior expectations

To go beyond simple summaries of the fitted model, we recommend using the `tidybayes` package.
For example, to obtain the posterior expectation of the delay distribution, under no censoring or truncation, we may use the `modelr::data_grid()` function in combination with the `tidybayes::add_epred_draws*(` function.
The `tidybayes::add_epred_draws()` function uses the `posterior_epred_latent_lognormal` function implemented in `epidist` for the `latent_lognormal` custom `brms` family.
First, for the model with no stratification (Figure \@ref(fig:epred-base)):

```{r}
epred_draws <- obs_prep |>
  as.data.frame() |>
  data_grid(NA) |>
  mutate(obs_t = NA, pwindow_upr = NA, swindow_upr = NA) |>
  add_epred_draws(fit, dpar = TRUE)
```

(ref:epred-base) The fitted posterior expectation of the delay distribution for a model with no stratification.

```{r epred-base, fig.cap="(ref:epred-base)"}
epred_draws |>
  ggplot(aes(x = .epred)) +
  stat_slab() +
  labs(x = "Posterior expectation of the delay", y = "") +
  theme_minimal()
```

Next, for the sex stratified model, we illustrate the higher mean of men as compared with women (Figure \@ref(fig:epred-sex)):

```{r}
newdata_sex <- obs_prep |>
  as.data.frame() |>
  data_grid(sex) |>
  mutate(obs_t = NA, pwindow_upr = NA, swindow_upr = NA)

epred_draws_sex <- add_epred_draws(newdata_sex, fit_sex, dpar = TRUE)
```

(ref:epred-sex) The fitted posterior expectation of the delay distribution for a model with sex stratification.

```{r epred-sex, fig.cap="(ref:epred-sex)"}
epred_draws_sex |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .epred, y = sex)) +
  stat_halfeye() +
  labs(x = "Posterior expectation of the delay", y = "") +
  theme_minimal()
```

Finally, the sex-district stratified model is shown in Figure \@ref(fig:epred-sex).
Note that these results are questionable, and suggest that further would should be done refining the prior distributions for the model.
Part of the issue is that some sex-district strata have quite limited data.

```{r}
epred_draws_sex_district <- obs_prep |>
  as.data.frame() |>
  data_grid(sex, district) |>
  mutate(obs_t = NA, pwindow_upr = NA, swindow_upr = NA) |>
  add_epred_draws(fit_sex_district, dpar = TRUE)
```

(ref:epred-sex-district) The fitted posterior expectation of the delay distribution for a model with sex-district stratification.

```{r epred-sex-district, fig.cap="(ref:epred-sex-district)"}
epred_draws_sex_district |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .epred, y = district)) +
  stat_pointinterval() +
  facet_grid(. ~ sex) +
  labs(x = "Posterior expectation of the delay", y = "") +
  theme_minimal()
```

## Linear predictor posteriors

The `tidybayes` package also allows users to generate draws of the linear predictors for all distributional parameters using `tidybayes::add_linpred_draws()`.
For example, for the `mu` parameter in the sex-district stratified model:

```{r}
linpred_draws_sex_district <- obs_prep |>
  as.data.frame() |>
  data_grid(sex, district) |>
  mutate(obs_t = NA, pwindow_upr = NA, swindow_upr = NA) |>
  add_linpred_draws(fit_sex_district, dpar = TRUE)
```

(ref:linpred-sex-district) The posterior distribution of the linear predictor of `mu` parameter within the sex-district stratified model.

```{r linpred-sex-district, fig.cap="(ref:linpred-sex-district)"}
linpred_draws_sex_district |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = mu, y = district)) +
  stat_pointinterval() +
  facet_grid(. ~ sex) +
  labs(x = "Posterior of the mu linear predictor", y = "") +
  theme_minimal()
```

## Delay probability mass functions

Posterior predictions of the delay distribution are an important output of an analysis with the `epidist` package.
In this section, we demonstrate how to produce either a discrete probability mass function representation, or continuous probability density function representation of the delay distribution.

### Discrete probability mass function

The posterior predictive distribution under no truncation but daily censoring.

No stratification.

```{r}
newdata_pmf <- obs_prep |>
  as.data.frame() |>
  mutate(obs_t = 1000, pwindow_upr = 1, swindow_upr = 1)

draws_pmf <- predicted_draws(fit, newdata = newdata_pmf, ndraws = 1000)
```

There were `r round(mean(draws_pmf$.prediction > 30) * 100, 1)`% of delays greater than 30, which are omitted in the following figure.

```{r}
ggplot(draws_pmf, aes(x = .prediction)) +
  geom_bar(aes(y = after_stat(count / sum(count)))) +
  labs(x = "PMF with daily censoring and no truncation", y = "") +
  scale_x_continuous(limits = c(0, 30)) +
  theme_minimal()
```

Stratification by sex:

```{r}
newdata_sex_pmf <- obs_prep |>
  as.data.frame() |>
  data_grid(sex) |>
  mutate(obs_t = 1000, pwindow_upr = 1, swindow_upr = 1)

draws_sex_pmf <- predicted_draws(
  fit_sex,
  newdata = newdata_sex_pmf,
  ndraws = 1000
)
```

```{r}
draws_sex_pmf |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .prediction)) +
  geom_bar(aes(y = after_stat(count / sum(count)))) +
  labs(x = "PMF with daily censoring and no truncation", y = "") +
  facet_grid(. ~ sex) +
  theme_minimal()
```

Stratification by sex-district:

```{r}
newdata_sex_district_pmf <- obs_prep |>
  as.data.frame() |>
  data_grid(sex, district) |>
  mutate(obs_t = 1000, pwindow_upr = 1, swindow_upr = 1)

draws_sex_district_pmf <- predicted_draws(
  fit_sex_district,
  newdata = newdata_sex_district_pmf,
  ndraws = 1000
)
```

```{r}
draws_sex_district_pmf |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .prediction)) +
  geom_bar(aes(y = after_stat(count / sum(count)))) +
  labs(x = "PMF with daily censoring and no truncation", y = "") +
  facet_grid(district ~ sex) +
  theme_minimal()
```

### Continuous probability density function

The posterior predictive distribution under no truncation and no censoring.
That is to produce continuous delay times.

No stratification:

```{r}
newdata_pdf <- obs_prep |>
  as.data.frame() |>
  mutate(obs_t = 1000, pwindow_upr = 0.001, swindow_upr = 0.001)

draws_pdf <- predicted_draws(fit, newdata = newdata_pdf, ndraws = 1000)
```

```{r}
ggplot(draws_pdf, aes(x = .prediction)) +
  geom_density() +
  labs(x = "PDF with no censoring and no truncation", y = "") +
  theme_minimal()
```

Stratification by sex:

```{r}
newdata_sex_pdf <- obs_prep |>
  as.data.frame() |>
  data_grid(sex) |>
  mutate(obs_t = 1000, pwindow_upr = 0.001, swindow_upr = 0.001)

draws_sex_pdf <- predicted_draws(
  fit_sex,
  newdata = newdata_sex_pdf,
  ndraws = 1000
)
```

```{r}
draws_sex_pmf |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .prediction)) +
  geom_density() +
  labs(x = "PDF with no censoring and no truncation", y = "") +
  facet_grid(. ~ sex) +
  theme_minimal()
```

Stratification by sex:

```{r}
newdata_sex_district_pdf <- obs_prep |>
  as.data.frame() |>
  data_grid(sex, district) |>
  mutate(obs_t = 1000, pwindow_upr = 0.001, swindow_upr = 0.001)

draws_sex_district_pdf <- predicted_draws(
  fit_sex_district,
  newdata = newdata_sex_district_pdf,
  ndraws = 1000
)

```{r}
draws_sex_district_pdf |>
  mutate(
    sex = case_when(
      sex == "F" ~ "Female",
      sex == "M" ~ "Male"
    )
  ) |>
  ggplot(aes(x = .prediction)) +
  geom_density() +
  labs(x = "PDF with no censoring and no truncation", y = "") +
  facet_grid(district ~ sex) +
  theme_minimal()
```

## Model comparison

* Use `loo` and PSIS
* Find out if it's worth including sex as a covariate. Presumably yes given how different the delay distributions are
* Find out if it's worth including district as a random effects
  * What about spatially structured? Probably future work: how to include more structured random effects

# Using a gamma delay distribution

## Fitting 

* Just fit the best model from above here?
* Going to do the sex stratified one for now

```{r}
fit_sex_gamma <- epidist(
  data = obs_prep,
  formula = brms::bf(mu ~ 1 + sex, shape ~ 1 + sex),
  family = stats::Gamma(),
  algorithm = "laplace",
  refresh = 0,
  silent = 2,
  seed = 1
)

summary(fit_sex_gamma)
```

# Model selection

* Should we use the lognormal or gamma delay distribution?

# Conclusion

* The `epidist` package allows you to fit delay distribution models
* These models can be stratified by covariates such as sex and district
* You can use `tidybayes` for post-processing and prediction with fitted models
* The likelihood family may also be specified in `epidist`
* Model comparison may be performed via the `loo` package
* Factors that we did not take into account in this vignette include
  * Age: this would be a simple extension of the model
  * Time: it is less clear how appropriate it is to include time as a covariate in the model. That said, I think it is an important future direction because I expect the time point during the epidemic to be a clear confounder of delay duration. Given epidemic start time varies by district, the "district" effects in the model currently are complicated by this fact

## Bibliography {-}
