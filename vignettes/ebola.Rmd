---
title: "Using `epidist` to estimate the delay between symptom onset and positive test for the 2014-2016 Ebola outbreak in Sierra Leone"
description: "A more detailed guide to using the `epidist` R package"
output: 
  bookdown::html_document2:
    fig_caption: yes
    code_folding: show
    number_sections: true
pkgdown:
  as_is: true
# csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
link-citations: true
vignette: >
  %\VignetteIndexEntry{Getting in depth with epidist}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r setup, include=FALSE}
# exclude compile warnings from cmdstanr
knitr::opts_chunk$set(
  fig.path = "figures/epidist-",
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

The 2014-2016 outbreak of Ebola in West Africa began in Guinea, and quickly spread to neighbouring Liberia and Sierra Leone.
It was the largest outbreak in the disease's history, and resulted in over 28,600 infections and 11,325 deaths [@who_ebola_2014_2016].

In this vignette, we use the `epidist` package to analyze line list data from the outbreak in Sierra Leone, as collated by @fang2016transmission.
In doing so, we demonstrate some of the features of `epidist`, including:

1. Fitting district-sex stratified delay distribution estimates.
2. Fitting models with lognormal and gamma delay distributions, and selecting between fitted models.
3. Investigating delay estimation scenarios. (A subset of the analysis in @park2024estimating, extended to the location-sex setting.)

For users new to `epidist`, before reading this article, we recommend beginning with the "[Getting started vignette](http://epidist.epinowcast.org/articles/epidist.html)".

The packages used in this article are:

```{r load-requirements}
library(epidist)
library(data.table)
library(purrr)
library(ggplot2)
library(sf)
```

# Data preparation

We begin by loading the Ebola line list data, as included in the `epidist` package (see `sierra_leone_ebola_data`):

```{r}
data("sierra_leone_ebola_data")
```

The data has `r nrow(sierra_leone_ebola_data)` rows, each corresponding to a unique case report `id`.
The columns of the data are the individuals name (retracted, and hence can be safely removed), age, sex, the dates of symptom onset and positive sample, and their district and chiefdom.

```{r}
head(sierra_leone_ebola_data)

sierra_leone_ebola_data <- sierra_leone_ebola_data |>
  dplyr::select(-name) |>
  dplyr::rename(case = id) |>
  dplyr::mutate(case = as.integer(case))
```

<!-- Question about whether to include shapefiles as data object in package. -->

```{r}
sierra_leone_ebola_data |>
  dplyr::group_by(district) |>
  dplyr::summarize(n = dplyr::n()) |>
  dplyr::arrange(desc(n))
```

```{r}
sf <- sf::st_read("../inst/gadm41_SLE_shp/gadm41_SLE_2.shp")

sierra_leone_ebola_data_sf <- dplyr::select(sf, district = NAME_2, geometry) |>
  dplyr::left_join(
    sierra_leone_ebola_data |>
      dplyr::group_by(district) |>
      dplyr::summarise(cases = dplyr::n())
  )

ggplot(sierra_leone_ebola_data_sf, aes(fill = cases, geometry = geometry)) +
  geom_sf() +
  scale_fill_viridis_c(na.value = "lightgrey") +
  theme_minimal() +
  labs(fill = "Cases")
```

(ref:ebola-outbreak) Figure caption.

```{r ebola-outbreak, fig.cap="(ref:ebola-outbreak)", fig.height=9}
# Might want to move to using data.table code rather than dplyr here/everywhere
sierra_leone_ebola_data |>
  dplyr::filter(case %% 10 == 0) |>
  ggplot() +
    geom_segment(
      aes(
        x = date_of_symptom_onset, xend = date_of_sample_tested,
        y = case, yend = case
      ),
      col = "grey"
    ) +
    geom_point(aes(x = date_of_symptom_onset, y = case), col = "#56B4E9") +
    geom_point(aes(x = date_of_sample_tested, y = case), col = "#009E73") +
    facet_grid(district ~ .) +
    labs(x = "", y = "Case ID") +
    theme_minimal()
```

To prepare the data for use in `epidist`, we first rename the date columns as `ptime` (time of primary event) and `stime` (time of secondary event), as well as transforming to a `data.table`:

```{r}
sierra_leone_ebola_data <- sierra_leone_ebola_data |>
  dplyr::mutate(
    date_of_symptom_onset = lubridate::ymd(date_of_symptom_onset),
    date_of_sample_tested = lubridate::ymd(date_of_sample_tested),
    ptime = as.numeric(date_of_symptom_onset - min(date_of_symptom_onset)),
    stime = as.numeric(date_of_sample_tested - min(date_of_symptom_onset))
  ) |>
  dplyr::select(case, ptime, stime, age, sex, district) |>
  data.table::as.data.table()
```

Next, we use `observe_process()` to do add interval censoring columns:

```{r}
obs_cens <- epidist::observe_process(sierra_leone_ebola_data)

all(obs_cens$ptime == obs_cens$ptime_daily)
all(obs_cens$stime == obs_cens$stime_daily)

max(obs_cens$ptime)
max(obs_cens$stime)
```

The columns added are:

* `ptime_daily`: As the `ptime` was already daily then this is superfluous
* `ptime_lwr`:
* `ptime_upr`:
* `stime_daily`: As the `ptime` was already daily then this is superfluous
* `stime_lwr`:
* `stime_upr`:
* `delay_daily`:
* `delay_lwr`:
* `delay_upr`:
* `obs_at`: The maximum value of `stime`

# Fitting district-sex stratified delay distributions

* Fit most obvious lognormal with sex effect and district effect
* Translate fitted distribution to probability mass function

First fit model with no district-sex stratification.
Use the Laplace algorithm for speed:

```{r}
obs_prep <- as_latent_individual(obs_cens)

fit <- epidist::epidist(
  data = obs_prep,
  formula = brms::bf(mu ~ 1, sigma ~ 1),
  family = brms::lognormal(),
  algorithm = "laplace"
)

fit_district_sex <- epidist::epidist(
  data = obs_prep,
  formula = brms::bf(mu ~ 1 + district + sex, sigma ~ 1 + district + sex),
  family = brms::lognormal(),
  algorithm = "laplace"
)
```

# Model selection

* Is it worth including sex as a covariate? What about spatially structured?
* Is it worth including district as a covariate?
* Should we use the lognormal or gamma delay distribution?
* Extract posterior predictions (of something) from all models â€“ posterior predictive checking?

# Delay estimation scenarios

When the epidemic is concluded, to obtain the best delay distribution estimates, we should use all of the available (censored) data.
However, during a novel outbreak we can't wait until the epidemic is over to begin estimating delays.
The `epidist` package faciliates assessing how the delay distribution estimates change depending on the time of estimation.

Here, we consider estimation at 120 days, as well as after the epidemic is concluded at 483 days.
@park2024estimating also consider estimation at X, Y and Z days.

```{r}
estimation_times <- data.table(
  scenario = c("120 days", "483 days"),
  time = c(120, 483)
)

obs_cens_trunc <- purrr::pmap(estimation_times, function(scenario, time) {
  obs_cens |>
    filter_obs_by_obs_time(obs_time = time) |>
    dplyr::mutate(
      scenario = scenario,
      obs_type = "real_time"
    ) |>
    dplyr::filter(ptime_lwr >= time - 60)
})

map(obs_cens_trunc, nrow)
```

Create retrospective observations.
The point is that these don't have any truncation.
They contain all cases where the primary event happened before `time`, even if the secondary event occured after `time`.

```{r}
obs_cens_retro <- purrr::pmap(estimation_times, function(scenario, time) {
  obs_cens |>
    filter_obs_by_ptime(obs_time = time, obs_at = "max_secondary") |>
    dplyr::mutate(
      scenario = scenario,
      obs_type = "retrospective"
    ) |>
    dplyr::filter(ptime_lwr >= time - 60)
})

map(obs_cens_retro, nrow)
```

One thing we can do here is go to aggregate incidence.
Why would we want to do this?
It's used as inputs in other places.

```{r}
# inc <- event_to_incidence(obs_cens_retro, by = "scenario")
# head(inc)
# dim(inc)
```

```{r}
obs_combined <- dplyr::bind_rows(
  obs_cens_trunc,
  obs_cens_retro
) |>
  dplyr::group_by(scenario, obs_type) |>
  dplyr::mutate(
    sample_size = dplyr::n()
  ) |>
  as.data.table()

nrow(obs_combined)
```

What are all the scenarios we have here?

```{r}
obs_combined |>
  dplyr::select(scenario, obs_type, sample_size) |>
  unique() |>
  dplyr::mutate(id = 1:dplyr::n())
```

# Model fitting

Fit the selected model.

```{r}
obs_combined <- dplyr::rename(obs_combined, case = id)
obs_combined$case <- as.integer(obs_combined$case)
obs_combined <- as_latent_individual(obs_combined)
obs_combined_list <- split(obs_combined, by = c("scenario", "obs_type"))

# fit_lognormal_models <- map(obs_combined_list, epidist::epidist)
```


# Appendix

```{r eval = FALSE}
# I think that aligning the Ebola data by chiefdom is too hard
# Going to use district-level approach for now

library(epidist)
library(data.table)
library(purrr)
library(ggplot2)
library(sf)

data("sierra_leone_ebola_data")

head(sierra_leone_ebola_data)
sierra_leone_ebola_data <- dplyr::select(sierra_leone_ebola_data, -name)

sierra_leone_ebola_data |>
  dplyr::group_by(chiefdom) |>
  dplyr::summarize(n = dplyr::n()) |>
  dplyr::arrange(desc(n))

sf <- sf::st_read("../inst/gadm41_SLE_shp")

ggplot(data = sf) +
  geom_sf() +
  geom_sf_text(aes(label = NAME_3), size = 2) +
  theme_minimal()

sort(setdiff(unique(sf$NAME_3), unique(sierra_leone_ebola_data$chiefdom)))
sort(setdiff(unique(sierra_leone_ebola_data$chiefdom), unique(sf$NAME_3)))

sierra_leone_ebola_data <- sierra_leone_ebola_data |>
  dplyr::mutate(chiefdom = forcats::fct_recode(chiefdom,
    "Boama" = "Baoma",
    "Dia" = "Dea",
    "Jawie" = "Jawei",
    "Kissi Tongi" = "Kissi Tonge",
    "Kando Leppeama" = "Kandu Leppiama",
    "Pehe Bongre" = "Peje Bongre",
    "Gbendembu Ngowahun" = "Ngowahun",
    "replace" = "Bkm",
    "Bumpe" = "Bumpe Ngawo",
    "Gbanti Kamaranka" = "Gbanti-Kamaranka",
    "Gbinleh-Dixon" = "Gbinle-Dixing",
    "Jiama-Bongor" = "Jaiama Bongor",
    "Kafe Simira" = "Kafe Simiria",
    "Kagboro" = "Kargboro",
    "replace" = "Kasonko",
    "replace" = "Kholifa",
    "replace" = "Kpanga Kabonde",
    "replace" = "Lokomasam",
    "replace" = "Tms",
    "Timdel" = "Timidale",
    "replace" = "W/Rural",
    "Freetown1" = "W/Urban",
    "Freetown2" = "W/Urban",
    "Freetown3" = "W/Urban",
    "Freetown4" = "W/Urban",
    "Freetown5" = "W/Urban",
    "Tambakha" = "Tambakka"
  ))

sierra_leone_ebola_data_sf <- dplyr::select(sf, chiefdom = NAME_3, geometry) |>
  dplyr::left_join(
    sierra_leone_ebola_data |>
      dplyr::group_by(chiefdom) |>
      dplyr::summarise(cases = dplyr::n())
  )

sum(sierra_leone_ebola_data_sf$cases, na.rm = TRUE)
nrow(sierra_leone_ebola_data)

ggplot(sierra_leone_ebola_data_sf, aes(fill = cases, geometry = geometry)) +
  geom_sf() +
  scale_fill_viridis_c(na.value = "lightgrey") +
  theme_minimal() +
  labs(fill = "Cases")
```
## Bibliography {-}