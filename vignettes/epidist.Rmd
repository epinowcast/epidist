---
title: "Getting started with epidist"
description: "A quick start guide to using the epidist R package"
output: 
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
link-citations: true
vignette: >
  %\VignetteIndexEntry{Getting started with epidist}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
# exclude compile warnings from cmdstanr
knitr::opts_chunk$set(
  fig.path = "figures/getting-started-nowcasting-",
  cache = TRUE,
  dpi = 330,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  eval = TRUE
)
```

In epidemiology, many important quantities can be thought of as the time between two events, or as delays.
Examples include:

* the incubation period (time between infection and symptom onset)
* serial interval (time between symptom onset of infectee and symptom onset of infected), and 
* generation interval (time between infection of infectee and infection of infected).

Unfortunately, estimating these quantities accurately from observational data is usually difficult.
In our experience, the two main issues are interval censoring and right truncation.
The `epidist` package makes it easy to estimate delays using a statistical model which properly accounts for these two issues.

## Example data

```{r load-requirements}
library(epidist)
library(data.table)
library(purrr)
library(ggplot2)
```

Here we quickly generate some simulated example data.
We focus on the format that the data needs to take for it to work with the fitting function.
Eventually, we discuss the tools available in the package to get your data into the right format, or we link to a vignette about it.

```{r}
outbreak <- simulate_gillespie(seed = 101)

secondary_dist <- data.table(meanlog = 1.8, sdlog = 0.5) |>
  add_natural_scale_mean_sd()

truncated_obs <- outbreak |>
  simulate_secondary(
    meanlog = secondary_dist[["meanlog"]],
    sdlog = secondary_dist[["sdlog"]]
  ) |>
  observe_process() |>
  filter_obs_by_obs_time(obs_time = 25) %>%
  .[sample(1:.N, 200, replace = FALSE)]
```

## Fit the model

We fit the model adjusting for right truncation and date censoring using a latent variable approach.
We briefly describe the model, and the inference methodology.
Eventually, we link to a vignette about common issues with model fitting and HMC.

```{r}
fit <- latent_truncation_censoring_adjusted_delay(
  data = truncated_obs, cores = 4, refresh = 0
)
```

## Compare estimates to reality

Compare modelled estimate to underlying truth here to convince user that it works.
Perhaps as an exercise, we could show the "really simple" estimate being wrong here otherwise it won't be so impressive that the model is right.
This section should also show the user how to get objects that they might want out of the fitted object.

```{r}
draws <- extract_lognormal_draws(fit)
draws_long <- draws_to_long(draws)
summarise_draws(draws_long, sf = 2)
```