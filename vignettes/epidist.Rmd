---
title: "Getting started with epidist"
description: "A quick start guide to using the epidist R package"
output: 
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa-numeric-superscript-brackets.csl
link-citations: true
vignette: >
  %\VignetteIndexEntry{Getting started with epidist}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
# exclude compile warnings from cmdstanr
knitr::opts_chunk$set(
  fig.path = "figures/getting-started-nowcasting-",
  cache = TRUE,
  dpi = 330,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  eval = TRUE
)
```

```{r load-requirements}
library(epidist)
library(data.table)
library(purrr)
library(ggplot2)
```

Many important quantities in epidemiology can be thought of as the time between two events, or "delays".
Examples include:

* the incubation period (time between infection and symptom onset)
* serial interval (time between symptom onset of infectee and symptom onset of infected), and 
* generation interval (time between infection of infectee and infection of infected).

Unfortunately, estimating delays accurately from observational data is usually difficult.
In our experience, the two main issues are interval censoring and right truncation.
The `epidist` package makes it easy to estimate delays using a statistical model which properly accounts for these two issues.

## Example data

Data must be in a particular format to be used within the `epidist` package.
In this section, we use package functions to simulate data of the appropriate format.
<!-- Please see as of yet unwritten vignette for information about how to transform your data of other formats to the right format. -->

We start by using the [Gillepsie algorithm](https://en.wikipedia.org/wiki/Gillespie_algorithm) to generate infectious disease outbreak data from a stochastic compartmental model:

```{r}
outbreak <- simulate_gillespie(seed = 101)
```

`outbreak` is a `data.table` object, with two columns: the case number `case` and the time of primary event `ptime`.

For the delay between primary and secondary event, we will use a lognormal distribution:

```{r}
secondary_dist <- data.table(meanlog = 1.8, sdlog = 0.5) |>
  add_natural_scale_mean_sd()

obs <- outbreak |>
  simulate_secondary(
    meanlog = secondary_dist[["meanlog"]],
    sdlog = secondary_dist[["sdlog"]]
  )

head(obs)
```

Now we are ready to simulate observation of the epidemic process at time `obs_time`:
<!-- Note: Adam doesn't really understand `observe_process()` and `filter_obs_by_obs_time()` yet. -->
<!-- When he does he'll write something better here. -->

```{r}
obs_time <- 25

obs <- obs |>
  observe_process() |>
  filter_obs_by_obs_time(obs_time = obs_time)
```

Finally, we suppose that only a random sample of individuals of size `sample_size` are observed:

```{r}
sample_size <- 200
obs <- obs[sample(1:.N, sample_size, replace = FALSE)]
```

## Fit the model

We fit the model adjusting for right truncation and date censoring using a latent variable approach.
We briefly describe the model, and the inference methodology.
Eventually, we link to a vignette about common issues with model fitting and HMC.

```{r}
fit <- latent_truncation_censoring_adjusted_delay(
  data = obs, cores = 4, refresh = 0
)
```

## Compare estimates to reality

Compare modelled estimate to underlying truth here to convince user that it works.
Perhaps as an exercise, we could show the "really simple" estimate being wrong here otherwise it won't be so impressive that the model is right.
This section should also show the user how to get objects that they might want out of the fitted object.

```{r}
draws <- extract_lognormal_draws(fit)
draws_long <- draws_to_long(draws)
summarise_draws(draws_long, sf = 2)
```